name: Me_TW

on:
  workflow_dispatch:
  push:
    branches: [zh_TW_v2.4.3]
permissions: write-all
env:
  CARGO_INCREMENTAL: 0
  RUST_BACKTRACE: short
  HUSKY: 0
concurrency:
  # only allow per workflow per commit (and not pr) to run at a time
  group: "${{ github.workflow }} - ${{ github.head_ref || github.ref }}"
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

jobs:
  check_tag_version:
    name: Check Release Tag and package.json Version Consistency
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

  set_release_tag:
    name: Calculate Custom Tag Name
    runs-on: ubuntu-latest
    # 輸出計算好的 Tag 名稱，供其他 Job 使用
    outputs:
      tag_name: ${{ steps.calculate.outputs.tag_name }}
      base_version: ${{ steps.calculate.outputs.base_version }}
    steps:
      - name: Calculate Tag Name
        id: calculate
        run: |
          # 獲取分支名稱，例如 zh_TW_v2.4.3
          TAG_REF="${GITHUB_REF##*/}"
          CLEAN_TAG_NAME="$TAG_REF"

          # 檢查是否在分支上運行
          if [[ "$GITHUB_REF" == refs/heads/* ]]; then
            # Bash 字串替換：移除前綴 "zh_TW_"
            CLEAN_TAG_NAME="${TAG_REF/zh_TW_/}"
          fi

          # 1. 基礎版本號 (v2.4.3)
          BASE_VERSION="$CLEAN_TAG_NAME"
          
          # 2. 最終 Tag 名稱 (v2.4.3.tw)
          FINAL_TAG_NAME="${BASE_VERSION}.tw"

          # 設置為 Job Output
          echo "tag_name=$FINAL_TAG_NAME" >> $GITHUB_OUTPUT
          echo "base_version=$BASE_VERSION" >> $GITHUB_OUTPUT
        shell: bash

  release:
    name: Release Build
    needs: [check_tag_version, set_release_tag]
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            target: x86_64-pc-windows-msvc
          - os: windows-latest
            target: aarch64-pc-windows-msvc
          - os: macos-latest
            target: aarch64-apple-darwin
          - os: macos-latest
            target: x86_64-apple-darwin
          - os: ubuntu-22.04
            target: x86_64-unknown-linux-gnu

    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Rust Stable
        uses: dtolnay/rust-toolchain@stable

      - name: Add Rust Target
        run: rustup target add ${{ matrix.target }}

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
          save-if: false

      - name: Install dependencies (ubuntu only)
        if: matrix.os == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libxslt1.1 libwebkit2gtk-4.1-dev libayatana-appindicator3-dev librsvg2-dev patchelf

      - name: Install x86 OpenSSL (macOS only)
        if: matrix.target == 'x86_64-apple-darwin'
        run: |
          arch -x86_64 brew install openssl@3
          echo "OPENSSL_DIR=$(brew --prefix openssl@3)" >> $GITHUB_ENV
          echo "OPENSSL_INCLUDE_DIR=$(brew --prefix openssl@3)/include" >> $GITHUB_ENV
          echo "OPENSSL_LIB_DIR=$(brew --prefix openssl@3)/lib" >> $GITHUB_ENV
          echo "PKG_CONFIG_PATH=$(brew --prefix openssl@3)/lib/pkgconfig" >> $GITHUB_ENV

      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - uses: pnpm/action-setup@v4
        name: Install pnpm
        with:
          run_install: false

      - name: Pnpm install and check
        run: |
          pnpm i
          pnpm run prebuild ${{ matrix.target }}

      - name: Tauri build
        # 上游 5.24 修改了 latest.json 的生成逻辑，且依赖 tauri-plugin-update 2.10.0 暂未发布，故锁定在 0.5.23 版本
        uses: tauri-apps/tauri-action@v0.5.23
        env:
          NODE_OPTIONS: "--max_old_space_size=4096"
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}

        with:
          #tagName: ${{ github.ref_name }}
          tagName: ${{ needs.set_release_tag.outputs.tag_name }}
          releaseName: "Clash Verge Rev ${{ needs.set_release_tag.outputs.base_version }} zh_TW"
          releaseDraft: false
          uploadAssets: true
          prerelease: ${{ contains(github.ref_name, '-rc') }}
          tauriScript: pnpm
          args: --target ${{ matrix.target }}
          includeUpdaterJson: true

  release-update:
    if: ${{ !contains(github.ref_name, '-rc') }}
    name: Release Update
    runs-on: ubuntu-latest
    needs: [release]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - uses: pnpm/action-setup@v4
        name: Install pnpm
        with:
          run_install: false

      - name: Pnpm install
        run: pnpm i

      - name: Release updater file
        run: pnpm updater
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
